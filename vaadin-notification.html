<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../vaadin-overlay/vaadin-overlay.html">

<dom-module id="vaadin-notification-overlay-default-theme" theme-for="vaadin-notification-overlay">
  <template>
    <style>
      [part="backdrop"] {
        display: none !important;
      }

      [part="overlay"] {
        background: transparent !important;
        box-shadow: none;
      }
    </style>
  </template>
</dom-module>

<dom-module id="vaadin-notification-mat-default-theme" theme-for="vaadin-notification-mat">
  <template>
    <style>
      :host {
        justify-content: space-between;
        padding: 8px;
      }
    </style>
  </template>
</dom-module>

<dom-module id="vaadin-notification-card-default-theme" theme-for="vaadin-notification-card">
  <template>
    <style>
      :host {
        padding: 8px;
        min-width: 18em;
        max-width: 36em;
        font-size: 12px;
        background: #fff;
        box-shadow: 0 2px 4px 0 rgba(0,0,0,0.3);
        margin: 5px 0;
        max-height: 15em;
      }
    </style>
  </template>
</dom-module>

<dom-module id="vaadin-notification-mat">
  <template>
    <style>
      :host {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        box-sizing: border-box;
        overflow: auto;

        display: flex;
        flex-direction: column;
        pointer-events: none;
      }

      div[part="top"],
      div[part="center"],
      div[part="bottom"] {
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
      }

      div[part="top"] {
        /* Alternatively, append to DOM in reverse order */
        flex-direction: column-reverse;
      }

      div[part="top"],
      div[part="bottom"] {
        flex: auto;
        flex-shrink: 1;
        flex-basis: 0;
      }
    </style>
    <div part="top"></div>
    <div part="center"></div>
    <div part="bottom"></div>
  </template>
</dom-module>

<dom-module id="vaadin-notification-card">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
      }

      :host([start]) {
        align-self: flex-start;
        order: 3;
      }

      :host([end]) {
        align-self: flex-end;
        order: 2;
      }

      :host([center]) {
        align-self: center;
        order: 1;
      }

      :host([stretch]) {
        order: 4;
        max-width: 100vw;
      }

    </style>
    <slot></slot>
  </template>
</dom-module>

<dom-module id="vaadin-notification">
  <template>
    <style>
      :host > * {
        display: none;
      }
    </style>
    <vaadin-notification-overlay id="vaadin-notification-overlay"
      modeless
      role="alert"
      aria-live="polite">
      <template id="vaadin-notification-overlay-template">
        <vaadin-notification-mat></vaadin-notification-mat>
      </template>
    </vaadin-notification-overlay>
    <vaadin-notification-card id="vaadin-notification-card">
    </vaadin-notification-card>
  </template>

  <script>
    {
      /**
       * The overlay element.
       *
       * ### Styling
       *
       * See [`<vaadin-overlay>` documentation](https://github.com/vaadin/vaadin-overlay/blob/master/vaadin-overlay.html)
       * for `<vaadin-notification-overlay>` parts.
       *
       * @memberof Vaadin
       */
      class VaadinNotificationOverlay extends Vaadin.OverlayElement {
        static get is() {
          return 'vaadin-notification-overlay';
        }
      }

      /**
       * The surface element for notification regions
       *
       * ### Styling
       *
       * See [`<vaadin-overlay>` documentation](https://github.com/vaadin/vaadin-overlay/blob/master/vaadin-overlay.html)
       * for `<vaadin-notification-overlay>` parts.
       *
       * @memberof Vaadin
       * @mixes Vaadin.ThemableMixin
       */
      class VaadinNotificationMat extends Vaadin.ThemableMixin(Polymer.Element) {
        static get is() {
          return 'vaadin-notification-mat';
        }

        get top() {
          return this._top || (this._top = this.shadowRoot.querySelector('[part="top"]'));
        }

        get center() {
          return this._center || (this._center = this.shadowRoot.querySelector('[part="center"]'));
        }

        get bottom() {
          return this._bottom || (this._bottom = this.shadowRoot.querySelector('[part="bottom"]'));
        }

        hasNotifications() {
          return [this.top, this.center, this.bottom].reduce((prev, region) => region.hasChildNodes() || prev, false);
        }
      }

      /**
       * The container element for the notification
       *
       * ### Styling
       *
       * See [`<vaadin-overlay>` documentation](https://github.com/vaadin/vaadin-overlay/blob/master/vaadin-overlay.html)
       * for `<vaadin-notification-overlay>` parts.
       *
       * @memberof Vaadin
       * @mixes Vaadin.ThemableMixin
       */
      class VaadinNotificationCard extends Vaadin.ThemableMixin(Polymer.Element) {
        static get is() {
          return 'vaadin-notification-card';
        }
      }

      /**
       * `<vaadin-notification>` is a Polymer 2 element providing accessible and customizable notifications (toasts).
       *
       * ```
       * <vaadin-notification>
       *   <template>
       *     Your work has been saved
       *   </template>
       * </vaadin-notification>
       * ```
       *
       * @memberof Vaadin
       * @demo demo/index.html
       */
      class NotificationElement extends (class extends Polymer.Element {}) {
        static get is() {
          return 'vaadin-notification';
        }

        static get properties() {
          return {
            /**
             * The duration in milliseconds to show the notification.
             * Set to `0` or a negative number to disable the notification auto-closing.
             */
            duration: {
              type: Number,
              value: 3000,
              observer: '_durationChanged'
            },

            /**
             * True if the notification is currently displayed.
             */
            opened: {
              type: Boolean,
              value: false,
              notify: true,
              observer: '_openedChanged'
            },

            /**
             * Vertical alignment of the notification in the viewport
             * Valid values are `top|center|bottom`
             */
            verticalAlign: {
              type: String,
              value: 'bottom',
            },

            /**
             * Horizontal alignment of the notification in the viewport
             * Valid values are `start|center|end|stretch`
             */
            horizontalAlign: {
              type: String,
              value: 'start'
            }
          };
        }

        open() {
          this.opened = true;
        }

        close() {
          this.opened = false;
        }

        get _overlay() {
          if (!NotificationElement._overlay) {
            NotificationElement._overlay = this.$['vaadin-notification-overlay'];
            this._overlay._mat = this._overlay.root.querySelector('vaadin-notification-mat');
          }
          return NotificationElement._overlay;
        }

        get _mat() {
          return this._overlay._mat;
        }

        _openedChanged(opened) {
          if (opened) {
            this._overlay.opened = true;
            if (!this._instance) {
              const template = this.querySelector('template');
              const Templatizer = Polymer.Templatize.templatize(template, this, {
                instanceProps: {
                  detail: true,
                  target: true
                }
              });
              this._instance = new Templatizer({});
              this._card = this.$['vaadin-notification-card'];
              this._card.appendChild(this._instance.root);
              this._card.setAttribute('aria-label', this._instance.root.textContent.trim());
            }

            this._appendNotificationCard();
            this._addAutocloseTimeout(this.duration);
          } else if (this._card) {
            this._removeNotificationCard();
          }
        }

        _appendNotificationCard() {
          ['start', 'center', 'end', 'stretch'].forEach(attr => this._card.removeAttribute(attr));
          this._card.setAttribute(this.horizontalAlign, '');
          this._mat[this.verticalAlign].appendChild(this._card);
        }

        _removeNotificationCard() {
          this._durationTimeoutId && clearTimeout(this._durationTimeoutId);
          this._card.parentNode && this._card.parentNode.removeChild(this._card);
          this._overlay.opened = this._mat.hasNotifications();
        }

        _durationChanged(duration, oldVal) {
          if (oldVal !== undefined) { // Initialization, do nothing
            this._addAutocloseTimeout(duration);
          }
        }

        _addAutocloseTimeout(duration) {
          clearTimeout(this._durationTimeoutId);
          if (duration > 0) {
            this._durationTimeoutId = setTimeout(() => this.close(), duration);
          } else {
            delete this._durationTimeoutId;
          }
        }
      }

      customElements.define(VaadinNotificationOverlay.is, VaadinNotificationOverlay);
      customElements.define(VaadinNotificationMat.is, VaadinNotificationMat);
      customElements.define(VaadinNotificationCard.is, VaadinNotificationCard);
      customElements.define(NotificationElement.is, NotificationElement);

      /**
       * @namespace Vaadin
       */
      window.Vaadin = window.Vaadin || {};
      Vaadin.NotificationElement = NotificationElement;
    }
  </script>
</dom-module>
